<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WebSocket Chat</title>
    </head>
    <body>
        <h1>WebSocket Chat</h1>

        <div id="connection-status">Connecting...</div>
        <div id="connected-users">0</div>
        <div id="chat-container"></div>

        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" />
            <button type="submit">Send</button>
        </form>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const chatContainer = document.getElementById('chat-container');
                const messageForm = document.getElementById('message-form');
                const messageInput = document.getElementById('message-input');
                const connectionStatus = document.getElementById('connection-status');
                const connectedUsers = document.getElementById('connected-users');

                // Determine WebSocket URL based on current location
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;

                // Connect to WebSocket server
                const socket = new WebSocket(wsUrl);

                // Handle connection open
                socket.addEventListener('open', () => {
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.style.color = 'green';

                    // Enable the message form
                    messageForm.querySelector('button').disabled = false;
                    messageInput.disabled = false;
                });

                // Handle connection close
                socket.addEventListener('close', () => {
                    connectionStatus.textContent = 'Disconnected - Refresh to reconnect';
                    connectionStatus.style.color = 'red';

                    // Disable the message form
                    messageForm.querySelector('button').disabled = true;
                    messageInput.disabled = true;
                });

                // Handle WebSocket errors
                socket.addEventListener('error', (error) => {
                    console.error('WebSocket error:', error);
                    connectionStatus.textContent = 'Connection error - See console for details';
                    connectionStatus.style.color = 'red';
                });

                // Handle incoming messages
                socket.addEventListener('message', (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log(data);

                        switch (data.type) {
                            case 'connectedUsers':
                                connectedUsers.textContent = data.message;
                                break;
                            case 'computation':
                                console.log('Computing stuff...');
                                const response = {
                                    type: 'computationResult',
                                    message: data.message.map((x) => x + 1),
                                    nodeId: data.nodeId,
                                };
                                socket.send(JSON.stringify(response));
                                break;
                            case 'inferenceResult':
                                displayMessage(data);
                                break;
                            default:
                                console.error('Unknown type');
                        }
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                });

                // Handle form submission
                messageForm.addEventListener('submit', (event) => {
                    event.preventDefault();

                    const message = messageInput.value.trim();
                    if (!message) return;

                    const messageObj = {
                        type: 'inferenceRequest',
                        message,
                    };
                    socket.send(JSON.stringify(messageObj));

                    // Clear input field
                    messageInput.value = '';
                });

                // Display message in chat container
                function displayMessage(data) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message';

                    if (data.type === 'system') {
                        // System message
                        messageDiv.className += ' system-message';
                        messageDiv.textContent = data.message;
                    } else if (data.type === 'chat') {
                        // Format timestamp
                        const timestamp = new Date(data.timestamp);
                        const timeString = `${timestamp.getHours().toString().padStart(2, '0')}:${timestamp
                            .getMinutes()
                            .toString()
                            .padStart(2, '0')}`;

                        messageDiv.innerHTML = `<small>[${timeString}]</small>:<div>${data.message}</div>`;
                    }

                    // Add message to chat container
                    chatContainer.appendChild(messageDiv);

                    // Auto-scroll to the bottom
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            });
        </script>
    </body>
</html>
